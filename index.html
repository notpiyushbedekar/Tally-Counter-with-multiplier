<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tally Counter — Persistent Local</title>
  <link rel="icon" href="favicon.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#08121a" />

  <!-- iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tally Counter">
  <link rel="apple-touch-icon" href="favicon.png">

  <style>
    :root{
      --bg1:#071217;--bg2:#0b1b23;--panel:#07121a;--teal:#1bb0a8;--teal-dark:#0ea79b;--muted:#98a4ad;--glass:rgba(255,255,255,0.04);
      --accent:#ef4444;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#d6e1e8}
    .wrap{max-width:420px;margin:24px auto;padding:20px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);box-shadow:0 12px 30px rgba(2,6,12,0.6);}
    h1{margin:0;font-size:22px;font-weight:700}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px}
    .center{display:flex;flex-direction:column;align-items:center}
    .count{font-size:80px;font-weight:700;margin:18px 0}
    .last{color:var(--muted);font-size:14px;margin-bottom:10px}
    .big-button{width:320px;height:320px;border-radius:50%;background:linear-gradient(180deg,var(--teal),var(--teal-dark));display:flex;align-items:center;justify-content:center;font-size:46px;font-weight:700;color:#012;box-shadow:0 30px 40px rgba(10,30,34,0.6),inset 0 -6px 10px rgba(255,255,255,0.02);cursor:pointer;user-select:none}
    .controls{display:flex;gap:12px;justify-content:center;margin-top:16px}
    .btn{padding:10px 18px;border-radius:10px;background:rgba(0,0,0,0.35);border:0;color:#dbe8ee;min-width:72px;text-align:center;cursor:pointer}
    .btn.negative{background:rgba(0,0,0,0.45)}
    .btn.reset{background:var(--accent);color:white}
    .row{display:flex;align-items:center;gap:12px;margin-top:18px}
    .label{flex:1;color:var(--muted);font-size:15px}
    input[type=range]{width:100%;-webkit-appearance:none;height:6px;background:linear-gradient(90deg,var(--teal),var(--teal-dark));border-radius:4px;outline:none}
    input[type=number]{width:80px;padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.03);color:#dbe8ee}
    .footer{color:var(--muted);font-size:13px;margin-top:10px}
    .small{font-size:13px;color:var(--muted)}
    @media(max-width:360px){.big-button{width:260px;height:260px;font-size:40px}.count{font-size:58px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Tally Counter</h1>
        <div class="subtitle">Persistent local counter</div>
      </div>
      <div id="multDisplay" style="background:rgba(255,255,255,0.03);padding:10px 12px;border-radius:18px;font-weight:700">×<span id="topMultiplier">1</span></div>
    </div>

    <div class="center">
      <div class="count" id="count">0</div>
      <div class="last" id="lastSaved">Last saved: —</div>

      <div class="big-button" id="bigBtn" tabindex="0">+1</div>

      <div class="controls">
        <button class="btn negative" id="minusBtn">-1</button>
        <button class="btn reset" id="resetBtn">Reset</button>
        <button class="btn" id="saveBtn">Save</button>
      </div>

      <div style="width:100%;margin-top:22px">
        <div class="row">
          <div class="label">Multiplier (scale)</div>
          <div style="width:160px;">
            <input id="multRange" type="range" min="0.1" max="5" step="0.1" value="1">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="label">Multiplier (exact)</div>
          <input id="multExact" type="number" step="0.1" min="0.1" value="1">
        </div>

        <div class="footer">Use Enter or Space on the big button to add.</div>
      </div>
    </div>
  </div>

<script>
// Keys: store state in localStorage
const STORAGE_KEY = 'tally_state_v1';
const AUTO_SAVE_DEBOUNCE = 400; //ms
let state = {count:0,mult:1,lastSaved:{value:0,mult:1,ts:0}};

function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ Object.assign(state, JSON.parse(raw)); }
  }catch(e){console.warn(e)}
  document.getElementById('count').textContent = state.count;
  document.getElementById('multRange').value = state.mult;
  document.getElementById('multExact').value = state.mult;
  document.getElementById('topMultiplier').textContent = trimMult(state.mult);
  renderLastSaved();
}

function saveLocal(){
  state._dirty = false;
  state._updated = Date.now();
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  catch(e){ console.warn('save failed', e); }
}

let autosaveTimer = null;
function scheduleAutosave(){
  if(autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(()=>{ saveLocal(); renderLastSaved(); }, AUTO_SAVE_DEBOUNCE);
}

function trimMult(m){ return Math.round(m*100)/100; }

function renderLastSaved(){
  const el = document.getElementById('lastSaved');
  if(state.lastSaved && state.lastSaved.ts){
    el.textContent = `Last saved: ${state.lastSaved.value} (×${trimMult(state.lastSaved.mult)})`;
  } else el.textContent = `Last saved: —`;
}

function updateCount(n){
  state.count = Math.round((state.count + n)*100)/100;
  document.getElementById('count').textContent = state.count;
  state._lastChange = Date.now();
  state._dirty = true;
  scheduleAutosave();
}

function doAdd(){
  const mult = Number(state.mult)||1;
  updateCount(mult);
}

// UI bindings
const bigBtn = document.getElementById('bigBtn');
bigBtn.addEventListener('click', ()=>{ doAdd(); });
bigBtn.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.code==='Space' || e.key===' '){ e.preventDefault(); doAdd(); } });

document.getElementById('minusBtn').addEventListener('click', ()=>{ updateCount(-1); });

document.getElementById('resetBtn').addEventListener('click', ()=>{
  state.count = 0; document.getElementById('count').textContent = 0; state._dirty=true; scheduleAutosave();
});

const saveBtn = document.getElementById('saveBtn');
saveBtn.addEventListener('click', ()=>{
  state.lastSaved = {value: state.count, mult: state.mult, ts: Date.now()};
  saveLocal(); renderLastSaved();
});

const multRange = document.getElementById('multRange');
const multExact = document.getElementById('multExact');
multRange.addEventListener('input', ()=>{
  const v = Number(multRange.value);
  state.mult = v; multExact.value = trimMult(v); document.getElementById('topMultiplier').textContent = trimMult(v);
  state._dirty=true; scheduleAutosave();
});
multExact.addEventListener('input', ()=>{
  let v = Number(multExact.value) || 1;
  if(v<0.1) v = 0.1; if(v>999) v = 999;
  state.mult = v; multRange.value = v; document.getElementById('topMultiplier').textContent = trimMult(v);
  state._dirty=true; scheduleAutosave();
});

// Save when window unloads
window.addEventListener('beforeunload', ()=>{ saveLocal(); });

// init
load();

// keyboard shortcuts
window.addEventListener('keydown',(e)=>{
  if(e.key === 'Enter' && document.activeElement === document.body){ doAdd(); }
});

// PWA Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').catch(console.warn);
}
</script>
</body>
</html>
